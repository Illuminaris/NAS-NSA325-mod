

# patch with BODHI's patches for 3.16 tree:
cd $KERNELWORKDIR/$KERNELCURRENT
patch -p1 <../linux-3.16.0-kirkwood-tld-2.patch


## Prep tree
cd $KERNELWORKDIR/$KERNELCURRENT
make distclean && make mrproper


# Set labels for configured features in kernel name and filename
# You can you use this to differentiate different builds
LOCALVERSION=""
KERNELSUFFIX=""
UIMAGE_SYMLINK=""


### CONFIG:

cat arch/arm/configs/kirkwood_defconfig - <<EOF > .config
### MIMINAL HARDWARE CONFIG FOR ZYXEL NSA-325v2
# System Type
CONFIG_ARCH_KIRKWOOD_DT=n
CONFIG_MACH_NSA325=y
# CPU Power Management
CONFIG_CPU_FREQ=n
CONFIG_ARM_KIRKWOOD_CPUIDLE=y
# Power Management
CONFIG_SUSPEND=n
CONFIG_PM_RUNTIME=n
#
CONFIG_ARCH_HAS_CPUFREQ=y
CONFIG_ARM_KIRKWOOD_CPUIDLE=y
# NSA325 has just 512MB ram
CONFIG_HIGHMEM=n
# This is important otherwise you get "__nand_correct_data: uncorrectable ECC error__nand_correct_data: uncorrectable ECC error"
CONFIG_MTD_BLOCK=n
# sensors support
CONFIG_I2C_GPIO=y
CONFIG_I2C_MV64XXX=y
CONFIG_HWMON=y
CONFIG_SENSORS_GPIO_FAN=y
CONFIG_SENSORS_LM75=y
CONFIG_SENSORS_NSA3XX=y
# Ethernet
CONFIG_MV643XX_ETH=y
# USB
CONFIG_USB_SUPPORT=y
CONFIG_USB=y
CONFIG_USB_XHCI_HCD=y
CONFIG_USB_EHCI_HCD=y
CONFIG_USB_EHCI_HCD_ORION=y
# RTC - MV seems broken, board will use PCF8563 instead
CONFIG_RTC_DRV_MV=y
CONFIG_RTC_DRV_PCF8563=y
# other hardware
CONFIG_ORION_WATCHDOG=y
CONFIG_MV_XOR=y
# LEDS
CONFIG_LEDS_TRIGGER_ONESHOT=y
CONFIG_LEDS_TRIGGER_IDE_DISK=y
CONFIG_LEDS_TRIGGER_HEARTBEAT=y
CONFIG_LEDS_TRIGGER_GPIO=y
CONFIG_LEDS_TRIGGER_DEFAULT_ON=y
CONFIG_LEDS_TRIGGER_TRANSIENT=y
# GPIO buttons
CONFIG_KEYBOARD_GPIO=y
# HW random generator
CONFIG_HW_RANDOM=y
# initramfs support (to be able to use root=LABEL=)
CONFIG_TMPFS=y
CONFIG_BLK_DEV_INITRD=y
# DEV KERNEL SUPPORT
CONFIG_DEVTMPFS=y
CONFIG_DEVTMPFS_MOUNT=y
# NetConsole support
CONFIG_NETCONSOLE=m
EOF


cat <<EOF >>.config
# No auto version label
CONFIG_LOCALVERSION_AUTO=n
# /proc/config.gz
CONFIG_IKCONFIG=y
CONFIG_IKCONFIG_PROC=y
# Prepends timings
CONFIG_PRINTK_TIME=y
EOF


grep "CONFIG_MACH_NSA325=y" .config
if [ $? = 0 ]; then
  LOCALVERSION=${LOCALVERSION}+mach
  KERNELSUFFIX=${KERNELSUFFIX}-mach
fi





# Reduce Kernel size
cat <<EOF >>.config
# Unused archs/machs selected by default kirkwood config
CONFIG_MACH_DLINK_KIRKWOOD_DT=n
CONFIG_MACH_NET2BIG_V2=n
CONFIG_MACH_NET5BIG_V2=n
CONFIG_MACH_OPENRD_BASE=n
CONFIG_MACH_OPENRD_CLIENT=n
CONFIG_MACH_OPENRD_ULTIMATE=n
CONFIG_MACH_RD88F6192_NAS=n
CONFIG_MACH_RD88F6281=n
CONFIG_MACH_T5325=n
CONFIG_MACH_TS219=n
CONFIG_MACH_TS41X=n
CONFIG_MACH_D2NET_V2=n
CONFIG_MACH_MV88F6281GTW_GE_DT=n
# Unused sensors selected by default kirkwood config
CONFIG_SENSORS_ADT7475=n
CONFIG_SENSORS_LM63=n
CONFIG_SENSORS_LM85=n
## Unused Device Drivers 
CONFIG_BLK_DEV_SR=n
# Device Drivers / LED Support
CONFIG_LEDS_NS2=n
CONFIG_LEDS_NETXBIG=n
# Device Drivers / Real Time Clock
CONFIG_RTC_DRV_RS5C372=n
CONFIG_RTC_DRV_S35390A=n
CONFIG_RTC_DRV_S35390A=n
# Device Drivers / Network device support / Ethernet driver support
# These are not wifi devices
CONFIG_NET_VENDOR_3COM=n
CONFIG_NET_VENDOR_ADAPTEC=n
CONFIG_NET_VENDOR_ALTEON=n
CONFIG_NET_VENDOR_AMD=n
CONFIG_NET_VENDOR_ARC=n
CONFIG_NET_VENDOR_ATHEROS=n
CONFIG_NET_CADENCE=n
CONFIG_NET_VENDOR_BROADCOM=n
CONFIG_NET_VENDOR_BROCADE=n
CONFIG_NET_VENDOR_CHELSIO=n
CONFIG_NET_VENDOR_CIRRUS=n
CONFIG_NET_VENDOR_CISCO=n
CONFIG_NET_VENDOR_DEC=n
CONFIG_NET_VENDOR_DLINK=n
CONFIG_NET_VENDOR_EMULEX=n
CONFIG_NET_VENDOR_EXAR=n
CONFIG_NET_VENDOR_FARADAY=n
CONFIG_NET_VENDOR_HP=n
CONFIG_NET_VENDOR_INTEL=n
CONFIG_NET_VENDOR_MELLANOX=n
CONFIG_NET_VENDOR_MICREL=n
CONFIG_NET_VENDOR_MICROCHIP=n
CONFIG_NET_VENDOR_MYRI=n
CONFIG_NET_VENDOR_NATSEMI=n
CONFIG_NET_VENDOR_NVIDIA=n
CONFIG_NET_VENDOR_OKI=n
CONFIG_NET_PACKET_ENGINE=n
CONFIG_NET_VENDOR_QLOGIC=n
CONFIG_NET_VENDOR_REALTEK=n
CONFIG_NET_VENDOR_RDC=n
CONFIG_NET_VENDOR_SEEQ=n
CONFIG_NET_VENDOR_SILAN=n
CONFIG_NET_VENDOR_SIS=n
CONFIG_NET_VENDOR_SMSC=n
CONFIG_NET_VENDOR_STMICRO=n
CONFIG_NET_VENDOR_SUN=n
CONFIG_NET_VENDOR_TEHUTI=n
CONFIG_NET_VENDOR_TI=n
CONFIG_NET_VENDOR_VIA=n
CONFIG_NET_VENDOR_WIZNET=n
EOF



# SCSI BLOCK LAYER 4
cat <<EOF >>.config
CONFIG_BLK_DEV_BSG=y
EOF

cat <<EOF >>.config
# Disk Partitions
CONFIG_PARTITION_ADVANCED=y
CONFIG_MSDOS_PARTITION=y
CONFIG_EFI_PARTITION=y
CONFIG_LDM_PARTITION=y
CONFIG_MAC_PARTITION=y
# Filesystems support
CONFIG_EXT2_FS=y
CONFIG_EXT3_FS=y
CONFIG_EXT4_FS=y
CONFIG_XFS_FS=m
CONFIG_FUSE_FS=m
CONFIG_MSDOS_FS=m
CONFIG_VFAT_FS=y
CONFIG_NTFS_FS=m
CONFIG_NTFS_RW=y
CONFIG_JFFS2_FS=m
CONFIG_HFS_FS=m
CONFIG_HFSPLUS_FS=m
EOF


cat <<EOF >>.config
# Disk Managers - MD
CONFIG_MD=y
# MD AUTODETECT IS DEPRECATED AND DOES NOT SEEM TO WORK ANYMORE
CONFIG_MD_AUTODETECT=n
CONFIG_BLK_DEV_MD=y
CONFIG_MD_LINEAR=y
CONFIG_MD_RAID0=y
CONFIG_MD_RAID1=y
# Disk Managers - LVM
CONFIG_BLK_DEV_DM=y
CONFIG_DM_CRYPT=m
CONFIG_DM_SNAPSHOT=m
CONFIG_DM_THIN_PROVISIONING=m
CONFIG_DM_MIRROR=n
CONFIG_DM_RAID=n
CONFIG_DM_UEVENT=y
EOF

# Further reduce Kernel size
cat <<EOF >>.config
# # Reduce kernel size not compiling unused stuff
# General setup section
CONFIG_PROFILING=n
CONFIG_KPROBES=n
# Kernel Hacking section
CONFIG_DEBUG_KERNEL=n
CONFIG_DEBUG_FS=n
CONFIG_FTRACE=n
CONFIG_UNUSED_SYMBOLS=n
CONFIG_STRIP_ASM_SYMS=y
# Security section
CONFIG_SECURITY=n
CONFIG_SECURITY_SELINUX=n
CONFIG_SECURITY_TOMOYO=n
CONFIG_SECURITY_APPARMOR=n
EOF


# OPTIONAL FEATURES BEGIN
##############################

cat <<EOF >>.config
# OpenVPN/IPSEC support
CONFIG_TUN=m
CONFIG_L2TP=m
CONFIG_INET_AH=m
CONFIG_INET_ESP=m
EOF


cat <<EOF >>.config
# Example of a WiFi Dongle: DLINK DWL-G122 rev C1 USB
CONFIG_RT2X00=m
CONFIG_RT73USB=m
EOF



# http://wiki.gentoo.org/wiki/Bluetooth
# http://wiki.gentoo.org/wiki/Bluetooth_Headset
# BLUETOOTH + SOUND SUPPORT
cat <<EOF >>.config
# SOUND SUPPORT
CONFIG_SOUND=m
CONFIG_SND=m
CONFIG_SND_SEQUENCER=m
CONFIG_SND_SEQ_DUMMY=m
CONFIG_SND_HRTIMER=m
CONFIG_SND_SEQ_HRTIMER_DEFAULT=y
CONFIG_SND_DYNAMIC_MINORS=y
CONFIG_SND_MAX_CARDS=4
CONFIG_SND_SUPPORT_OLD_API=y
CONFIG_SND_DRIVERS=y
# BLUETOOTH SUPPORT
CONFIG_BT=m
CONFIG_BT_RFCOMM=m
CONFIG_BT_RFCOMM_TTY=y
CONFIG_BT_BNEP=m
CONFIG_BT_BNEP_MC_FILTER=y
CONFIG_BT_BNEP_PROTO_FILTER=y
CONFIG_BT_HIDP=m
CONFIG_BT_HCIBTUSB=m
CONFIG_BT_HCIBTSDIO=m
CONFIG_BT_HCIUART=m
CONFIG_BT_HCIUART_H4=y
CONFIG_BT_HCIUART_BCSP=y
CONFIG_BT_HCIUART_ATH3K=y
CONFIG_BT_HCIUART_LL=y
CONFIG_BT_HCIUART_3WIRE=y
CONFIG_BT_HCIBCM203X=m
CONFIG_BT_HCIBPA10X=m
CONFIG_BT_HCIBFUSB=m
CONFIG_BT_HCIVHCI=m
CONFIG_BT_MRVL=m
CONFIG_BT_MRVL_SDIO=m
CONFIG_BT_ATH3K=m
# UINPUT for Headsets
CONFIG_INPUT_MISC=y
CONFIG_INPUT_UINPUT=m
EOF

# USB AUDIO SUPPORT
cat <<EOF >>.config
CONFIG_USB_AUDIO=m
CONFIG_SND_PCM=m
CONFIG_SND_HWDEP=m
CONFIG_SND_RAWMIDI=m
CONFIG_SND_RAWMIDI_SEQ=m
CONFIG_SND_USB_6FIRE=m
CONFIG_SND_USB_AUDIO=m
CONFIG_SND_USB_CAIAQ=m
CONFIG_SND_USB_HIFACE=m
CONFIG_SND_USB_UA101=m
CONFIG_SND_VMASTER=y
EOF


grep "CONFIG_BT=m" .config
if [ $? = 0 ]; then
  LOCALVERSION=${LOCALVERSION}+bt
  KERNELSUFFIX=${KERNELSUFFIX}-bt
fi


# USB-VGA from Magic Control Technology (SISUSBVGA)
cat <<EOF >>.config
CONFIG_FB=m
CONFIG_FRAMEBUFFER_CONSOLE=m
CONFIG_FRAMEBUFFER_CONSOLE_DETECT_PRIMARY=y
CONFIG_FB_UDL=m
CONFIG_VT_HW_CONSOLE_BINDING=y
CONFIG_VGA_ARB=y
CONFIG_USB_SISUSBVGA=m
CONFIG_USB_SISUSBVGA_CON=y
CONFIG_FONT_8x8=y
CONFIG_FONT_8x16=y
EOF


grep "CONFIG_VGA_ARB=y" .config
if [ $? = 0 ]; then
  LOCALVERSION=${LOCALVERSION}+vga
  KERNELSUFFIX=${KERNELSUFFIX}-vga
fi


# // OPTIONAL FEATURES END
##############################


# sets label for kernel
cat <<EOF >>.config
CONFIG_LOCALVERSION="$LOCALVERSION"
EOF



## This will bring up the well-known ncurses-based configuration program.
## At this stage, you can exit and save and it will be ready.

make menuconfig

## compile (adjust -j for your host - this is for 8 CPUs)

make -j8 uImage modules

	Image Name:   Linux-3.16.2+mach+bt+vga
	Created:      Sun Sep  7 13:10:37 2014
	Image Type:   ARM Linux Kernel Image (uncompressed)
	Data Size:    3210928 Bytes = 3135.67 kB = 3.06 MB
	Load Address: 00008000
	Entry Point:  00008000
	  Image arch/arm/boot/uImage is ready



	  

##################################################
# INSTALL KERNEL into ROOTFS tree:
##################################################

# find current compiled version (Major.Minor)
cd $KERNELWORKDIR/$KERNELCURRENT
KERNELVERSION=$(grep -m5 "Linux/arm .* Kernel Configuration" .config | sed 's/.*Linux\/arm \(.*\) Kernel Configuration/\1/g' | cut -d. -f1-3)


# COPY uImage+modules to RootFS for HDD/USB:
cp arch/arm/boot/uImage $RFShdd/boot/uImage-v${KERNELVERSION}${KERNELSUFFIX}
ln -sf uImage-v${KERNELVERSION}${KERNELSUFFIX} $RFShdd/boot/uImage${UIMAGE_SYMLINK}
make INSTALL_MOD_PATH=$RFShdd modules_install







